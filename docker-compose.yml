services:
  user_mysql:
    hostname: user_database
    image: mysql:5
    command: --default-authentication-plugin=mysql_native_password --sql-mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION"
    environment:
      MYSQL_ROOT_PASSWORD: /run/secrets/user_database_pssw
      MYSQL_DATABASE: user_api
      TZ: America/Sao_Paulo
    secrets:
      - user_database_pssw
    networks:
      - user_database_network
    deploy:
      placement:
        constraints:
          - node.role == worker
    # healthcheck:
    #   test: mysqladmin ping -h localhost -u root --password=$$MYSQL_ROOT_PASSWORD
    #   start_period: 5s
    #   interval: 5s
    #   timeout: 5s
    #   retries: 55

  user_api:
    hostname: user_api
    image: eduardogomesheleno/user_api:latest
    environment:
      - GOOSE_DBSTRING
      GOOSE_DRIVER: mysql
      GOOSE_MIGRATION_DIR: /app/database/migrations/
      GOOSE_TABLE: goose_migrations
      MYSQL_ROOT_PASSWORD: /run/secrets/user_database_pssw
    secrets:
      - user_database_pssw
    networks:
      - traefik_traefik_proxy
      - user_database_network
      - rabbitmq_network
      - redis_network
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.user-api.entrypoints=web"
        - "traefik.http.routers.user-api.rule=Host(`eduardodev.app.br`)"
        - "traefik.http.services.user-api.loadbalancer.server.port=8080"

      placement:
        constraints:
          - node.role == worker
    # depends_on:
    #   user_mysql:
    #     condition: service_healthy

networks:
  traefik_traefik_proxy:
    driver: overlay
    attachable: true
    external: true

  user_database_network:
    driver: overlay
    attachable: true
    external: true

  rabbitmq_network:
    driver: overlay
    attachable: true
    external: true

  redis_network:
    driver: overlay
    attachable: true
    external: true

secrets:
  user_database_pssw:
    external: true
